<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codeine</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%236FE6FC'/%3E%3Cpath d='M35 30 L20 50 L35 70' stroke='black' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M65 30 L80 50 L65 70' stroke='black' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cline x1='55' y1='25' x2='45' y2='75' stroke='black' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Ayu Light Theme */
            --bg-primary: #FAFAFA;
            --bg-secondary: #F3F4F5;
            --bg-sidebar: #FFFFFF;
            --text-primary: #575F66;
            --text-secondary: #8A9199;
            --border-color: #E7E8E9;
            --accent-color: #FF9940;
            --button-bg: #FF9940;
            --button-hover: #F2AE49;
            --sidebar-width-collapsed: 60px;
            --sidebar-width-expanded: 250px;
            /* Modal Colors */
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --modal-bg: #FFFFFF;
        }

        [data-theme="dark"] {
            /* Ayu Dark Theme */
            --bg-primary: #0A0E14;
            --bg-secondary: #0D1017;
            --bg-sidebar: #01060E;
            --text-primary: #B3B1AD;
            --text-secondary: #626A73;
            --border-color: #1F2430;
            --accent-color: #FFB454;
            --button-bg: #FFB454;
            --button-hover: #FFCC66;
            /* Modal Colors */
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --modal-bg: #01060E;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width-collapsed);
            background-color: var(--bg-sidebar);
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow-x: hidden;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .sidebar.expanded {
            width: var(--sidebar-width-expanded);
        }

        .sidebar-header {
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            min-height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            /* Il colore del testo 'Codeine' si abbina allo sfondo del logo */
            color: #6FE6FC; 
            font-size: 20px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .logo-icon {
            /* Dimensionamento dell'icona del logo */
            min-width: 28px;
            width: 28px;
            height: 28px;
        }

        .logo-text {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .logo-text {
            opacity: 1;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        [data-theme="dark"] .toggle-btn {
            color: white;
        }

        .toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            text-decoration: none;
            gap: 15px;
        }

        [data-theme="dark"] .menu-item {
            color: rgba(255, 255, 255, 0.8);
        }

        .menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--accent-color);
        }

        [data-theme="dark"] .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item svg {
            min-width: 24px;
            width: 24px;
            height: 24px;
        }

        .menu-item-text {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.3s ease;
            font-size: 14px;
        }

        .sidebar.expanded .menu-item-text {
            opacity: 1;
        }

        .menu-separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 10px 15px;
        }


        /* Contenuto principale */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Stili barra tab */
        .tab-bar {
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
        }
        
        .tab-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            background-color: transparent;
            transition: background-color 0.2s;
            font-size: 13px;
            color: var(--text-secondary);
            user-select: none; 
        }
        
        .tab-item.active {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .tab-item:hover {
            background-color: var(--bg-primary);
        }

        [data-theme="dark"] .tab-item.active {
            background-color: var(--bg-primary);
        }

        [data-theme="dark"] .tab-item:hover {
            background-color: var(--bg-primary);
        }
        
        .tab-item-name {
            margin-right: 8px;
        }
        
        .tab-item.modified .tab-item-name {
            font-style: italic;
        }

        .tab-item-modified-indicator {
            color: var(--text-primary);
            font-weight: bold;
            display: none;
        }

        .tab-item.modified .tab-item-modified-indicator {
            display: inline;
        }

        .tab-close {
            margin-left: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            padding: 2px;
            font-size: 14px;
            line-height: 1;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-close:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        [data-theme="dark"] .tab-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }
        
        /* Stili per il pulsante '+' */
        .add-tab-btn {
            background: none;
            border: none;
            border-right: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 0 12px;
            font-size: 20px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .add-tab-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .add-tab-btn {
            color: var(--text-primary);
        }

        [data-theme="dark"] .add-tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        /* Fine stili tab */
        

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor {
            flex: 1;
            width: 100%;
        }

        .status-bar {
            background-color: var(--bg-secondary);
            padding: 5px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-item {
            display: flex;
            gap: 20px;
        }

        /* Fullscreen styles */
        .fullscreen-active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        /* --- STILI PER LA MODALE --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background-color: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            min-width: 300px;
            max-width: 450px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(10px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal-box {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        .modal-btn:hover {
            background-color: var(--bg-secondary);
        }

        .modal-btn.primary {
            background-color: var(--button-bg);
            border-color: var(--button-bg);
            color: #fff;
            font-weight: 500;
        }

        .modal-btn.primary:hover {
            background-color: var(--button-hover);
        }

        [data-theme="dark"] .modal-btn.primary {
            color: #01060E; /* Testo scuro su bottone chiaro/arancione */
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
            }

            .tab-item {
                padding: 8px 10px;
            }
        }

        /* Scrollbar personalizzate globali */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.4);
        }

        /* Scrollbar per tema scuro */
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Scrollbar sidebar - più sottile */
        .sidebar::-webkit-scrollbar,
        .sidebar-menu::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar::-webkit-scrollbar-track,
        .sidebar-menu::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb,
        .sidebar-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover,
        .sidebar-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body data-theme="light">
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title">Titolo</div>
            <div id="modalMessage" class="modal-message">Messaggio</div>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        
        <div class="sidebar-header">
            <div class="logo">
                <svg class="logo-icon" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
                    <rect width='100' height='100' rx='20' fill='#6FE6FC'/>
                    <path d='M35 30 L20 50 L35 70' stroke='black' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/>
                    <path d='M65 30 L80 50 L65 70' stroke='black' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/>
                    <line x1='55' y1='25' x2='45' y2='75' stroke='black' stroke-width='6' stroke-linecap='round'/>
                </svg>
                <span class="logo-text">Codeine</span>
            </div>
            <button class="toggle-btn" onclick="toggleSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item" onclick="newFile()" title="Nuovo file (Ctrl+N)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="11" x2="12" y2="17"/>
                    <line x1="9" y1="14" x2="15" y2="14"/>
                </svg>
                <span class="menu-item-text">Nuovo</span>
            </div>

            <div class="menu-item" onclick="openFile()" title="Apri file (Ctrl+O)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"/>
                </svg>
                <span class="menu-item-text">Apri</span>
            </div>

            <div class="menu-item" onclick="saveFile()" title="Salva file (Ctrl+S)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                <span class="menu-item-text">Salva</span>
            </div>

            <div class="menu-item" onclick="downloadFile()" title="Download file">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span class="menu-item-text">Download</span>
            </div>

            <div class="menu-separator"></div>

            <div class="menu-item" onclick="toggleTheme()" title="Cambia tema">
                <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
                <span class="menu-item-text">Tema scuro</span>
            </div>

            <div class="menu-item" onclick="toggleFullscreen()" title="Fullscreen (F11)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
                <span class="menu-item-text">Fullscreen</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="tab-bar" id="tab-bar">
            </div>

        <div class="editor-container">
            <div id="editor"></div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span id="lineCol">Riga 1, Col 1</span>
                <span id="language">HTML</span>
            </div>
            <div class="status-item">
                <span id="encoding">UTF-8</span>
                <span id="modified"></span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <script>
        let editor;
        
        let tabs = []; 
        let activeTabId = null; 
        let untitledCounter = 1; 

        // Inizializza Monaco Editor
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            } 
        });

        // Imposta la lingua predefinita (Italiano) per l'UI di Monaco (es. menu contestuale)
        require.config({
            'vs/nls': {
                availableLanguages: {
                    '*': 'it' // 'it' è il codice per l'italiano
                }
            }
        });

        require(['vs/editor/editor.main'], function() {
            // Definisci tema Ayu Light personalizzato
            monaco.editor.defineTheme('ayu-light', {
                base: 'vs',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '8A9199', fontStyle: 'italic' },
                    { token: 'keyword', foreground: 'FF204E', fontStyle: 'bold' },
                    { token: 'string', foreground: '10b981' },
                    { token: 'number', foreground: '6FE6FC' },
                    { token: 'regexp', foreground: '10b981' },
                    { token: 'type', foreground: 'FF9940' },
                    { token: 'class', foreground: 'FF9940' },
                    { token: 'function', foreground: '6FE6FC' },
                    { token: 'variable', foreground: '575F66' },
                    { token: 'constant', foreground: 'FF204E' },
                    { token: 'tag', foreground: 'FF204E' },
                    { token: 'attribute.name', foreground: 'FF9940' },
                    { token: 'attribute.value', foreground: '10b981' },
                    { token: 'operator', foreground: 'FF204E' },
                    { token: 'delimiter', foreground: '575F66' },
                ],
                colors: {
                    'editor.foreground': '#575F66',
                    'editor.background': '#FAFAFA',
                    'editor.selectionBackground': '#FFD59980',
                    'editor.lineHighlightBackground': '#F3F4F5',
                    'editorCursor.foreground': '#FF9940',
                    'editorWhitespace.foreground': '#E7E8E9',
                    'editorLineNumber.foreground': '#8A9199',
                    'editorLineNumber.activeForeground': '#FF9940',
                }
            });

            // Definisci tema Ayu Dark personalizzato
            monaco.editor.defineTheme('ayu-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '626A73', fontStyle: 'italic' },
                    { token: 'keyword', foreground: 'FF204E', fontStyle: 'bold' },
                    { token: 'string', foreground: '10b981' },
                    { token: 'number', foreground: '6FE6FC' },
                    { token: 'regexp', foreground: '10b981' },
                    { token: 'type', foreground: 'FFB454' },
                    { token: 'class', foreground: 'FFB454' },
                    { token: 'function', foreground: '6FE6FC' },
                    { token: 'variable', foreground: 'B3B1AD' },
                    { token: 'constant', foreground: 'FF204E' },
                    { token: 'tag', foreground: 'FF204E' },
                    { token: 'attribute.name', foreground: 'FFB454' },
                    { token: 'attribute.value', foreground: '10b981' },
                    { token: 'operator', foreground: 'FF204E' },
                    { token: 'delimiter', foreground: 'B3B1AD' },
                ],
                colors: {
                    'editor.foreground': '#B3B1AD',
                    'editor.background': '#0A0E14',
                    'editor.selectionBackground': '#273747',
                    'editor.lineHighlightBackground': '#0D1017',
                    'editorCursor.foreground': '#FFB454',
                    'editorWhitespace.foreground': '#1F2430',
                    'editorLineNumber.foreground': '#626A73',
                    'editorLineNumber.activeForeground': '#FFB454',
                }
            });

            const theme = document.body.getAttribute('data-theme') || 'light';
            
            editor = monaco.editor.create(document.getElementById('editor'), {
                theme: theme === 'dark' ? 'ayu-dark' : 'ayu-light',
                automaticLayout: true,
                fontFamily: "'Fira Code', 'Courier New', monospace",
                fontLigatures: true,
                fontSize: 14,
                fontWeight: '400',
                lineNumbers: 'on',
                minimap: { enabled: true },
                wordWrap: 'on',
                formatOnPaste: true,
                formatOnType: true,
                autoClosingBrackets: 'always',
                autoClosingQuotes: 'always',
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                tabSize: 2,
                scrollBeyondLastLine: false
            });

            // Evento per aggiornare posizione cursore
            editor.onDidChangeCursorPosition((e) => {
                updateLineCol(e.position);
            });

            // Evento per tracciare modifiche
            editor.onDidChangeModelContent(() => {
                const activeTab = getActiveTab();
                if (activeTab && !activeTab.isModified) {
                    activeTab.isModified = true;
                    updateTabUI(activeTab); 
                    updateModifiedStatus(); 
                }
            });
            
            // Inizializza stato e crea la prima tab
            newFile(); 
            updateLineCol(editor.getPosition());
        });

        // --- Funzioni per la Modale ---
        
        function showModal(title, message) {
            const overlay = document.getElementById('modalOverlay');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            overlay.classList.add('active');
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('active');
        }

        // Chiudi modale cliccando fuori dal box
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                closeModal();
            }
        });

        // --- Funzioni di utilità per le tab ---

        function generateTabId() {
            return `tab-${Date.now()}-${Math.random()}`;
        }

        function getActiveTab() {
            return tabs.find(t => t.id === activeTabId);
        }
        
        function getTabById(tabId) {
            return tabs.find(t => t.id === tabId);
        }

        /** Determina il linguaggio dall'estensione del file */
        function getLanguageFromFileName(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            if (ext === 'css') return 'css';
            if (ext === 'js') return 'javascript';
            if (ext === 'html') return 'html';
            if (ext === 'md') return 'markdown';
            return 'plaintext'; // Default
        }
        
        /** Restituisce l'estensione corretta per un linguaggio */
        function getExtensionForLanguage(language) {
            const extensions = {
                'html': '.html',
                'css': '.css',
                'javascript': '.js',
                'markdown': '.md',
                'plaintext': '.txt'
            };
            return extensions[language] || '.txt';
        }

        // --- Funzioni core per le tab ---

        /** Crea una nuova tab */
        function createTab(name, language, content = '') {
            const tabId = generateTabId();
            const model = monaco.editor.createModel(content, language);
            
            const newTab = {
                id: tabId,
                name: name,
                language: language,
                model: model,
                viewState: null, 
                isModified: false
            };
            
            tabs.push(newTab);
            renderTabs(); 
            switchTab(tabId); 
            return newTab;
        }

        /** Disegna tutte le tab e il pulsante '+' nella barra delle tab */
        function renderTabs() {
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = ''; // Svuota la barra
            
            // Aggiungi il pulsante '+' all'inizio
            const addBtn = document.createElement('button');
            addBtn.className = 'add-tab-btn';
            addBtn.innerHTML = '+';
            addBtn.title = 'Nuova tab (Ctrl+N)';
            addBtn.onclick = newFile; // Chiama la funzione newFile esistente
            tabBar.appendChild(addBtn);

            // Aggiungi le tab esistenti
            tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = 'tab-item';
                tabEl.dataset.tabId = tab.id;
                
                if (tab.id === activeTabId) {
                    tabEl.classList.add('active');
                }
                if (tab.isModified) {
                    tabEl.classList.add('modified');
                }
                
                tabEl.innerHTML = `
                    <span class="tab-item-name">${tab.name}</span>
                    <span class="tab-item-modified-indicator">●</span>
                    <button class="tab-close" title="Chiudi">&times;</button>
                `;
                
                tabEl.querySelector('.tab-item-name').onclick = (e) => {
                    switchTab(tab.id);
                };
                
                tabEl.querySelector('.tab-close').onclick = (e) => {
                    e.stopPropagation(); 
                    closeTab(tab.id);
                };
                
                tabBar.appendChild(tabEl);
                
                if (tab.id === activeTabId) {
                    tabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        /** Passa a una tab differente */
        function switchTab(tabId) {
            if (activeTabId === tabId) return; 

            const oldTab = getActiveTab();
            if (oldTab) {
                oldTab.viewState = editor.saveViewState();
            }

            activeTabId = tabId;
            const newTab = getActiveTab();

            if (!newTab) {
                if (tabs.length > 0) {
                    switchTab(tabs[0].id);
                } else {
                    newFile();
                }
                return;
            }

            editor.setModel(newTab.model);
            if (newTab.viewState) {
                editor.restoreViewState(newTab.viewState);
            }
            editor.focus(); 

            // Aggiorna la UI (solo status bar ora)
            updateUIForActiveTab();
            
            renderTabs();
        }

        /** Chiude una tab */
        function closeTab(tabId) {
            const tabToClose = getTabById(tabId);
            if (!tabToClose) return;

            if (tabToClose.isModified) {
                if (!confirm(`Hai modifiche non salvate per "${tabToClose.name}". Chiudere comunque?`)) {
                    return; 
                }
            }

            tabs = tabs.filter(t => t.id !== tabId);
            
            tabToClose.model.dispose();
            
            if (activeTabId === tabId) {
                activeTabId = null; 
                if (tabs.length > 0) {
                    switchTab(tabs[tabs.length - 1].id);
                } else {
                    newFile();
                }
            } else {
                renderTabs();
            }
        }

        /** Aggiorna la UI (solo status bar) in base alla tab attiva */
        function updateUIForActiveTab() {
            const activeTab = getActiveTab();
            if (!activeTab) {
                // Stato vuoto se non ci sono tab
                document.getElementById('language').textContent = "---";
                updateModifiedStatus();
                updateLineCol(null);
                return;
            }
            
            // Aggiorna solo la status bar
            document.getElementById('language').textContent = activeTab.language.toUpperCase();
            updateModifiedStatus(); 
            updateLineCol(editor.getPosition()); 
        }
        
        /** Aggiorna la UI di una singola tab */
        function updateTabUI(tab) {
             const tabEl = document.querySelector(`.tab-item[data-tab-id="${tab.id}"]`);
             if (tabEl) {
                 tabEl.classList.toggle('modified', tab.isModified);
                 tabEl.querySelector('.tab-item-name').textContent = tab.name;
             }
        }

        // --- Funzioni UI principali ---
        
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            
            if (editor) {
                monaco.editor.setTheme(newTheme === 'dark' ? 'ayu-dark' : 'ayu-light');
            }
            
            const themeIcon = document.getElementById('themeIcon');
            const themeText = themeIcon.parentElement.querySelector('.menu-item-text');
            
            if (newTheme === 'dark') {
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
                if (themeText) themeText.textContent = 'Tema chiaro';
            } else {
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
                if (themeText) themeText.textContent = 'Tema scuro';
            }
            
            localStorage.setItem('theme', newTheme);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
            localStorage.setItem('sidebarExpanded', sidebar.classList.contains('expanded'));
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Errore fullscreen:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Carica tema e stato sidebar salvati
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                const themeIcon = document.getElementById('themeIcon');
                const themeText = themeIcon.parentElement.querySelector('.menu-item-text');
                
                if (savedTheme === 'dark') {
                    themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
                    if (themeText) themeText.textContent = 'Tema chiaro';
                }
            }
            
            const sidebarExpanded = localStorage.getItem('sidebarExpanded');
            if (sidebarExpanded === 'true') {
                document.getElementById('sidebar').classList.add('expanded');
            }
        });

        /** Aggiorna posizione cursore */
        function updateLineCol(position) {
            if (position) {
                document.getElementById('lineCol').textContent = 
                    `Riga ${position.lineNumber}, Col ${position.column}`;
            } else {
                document.getElementById('lineCol').textContent = `Riga 1, Col 1`;
            }
        }

        /** Aggiorna stato modificato */
        function updateModifiedStatus() {
            const activeTab = getActiveTab();
            const isMod = activeTab ? activeTab.isModified : false;
            document.getElementById('modified').textContent = 
                isMod ? '● Modificato' : '';
        }

        // --- Gestione File ---

        /** Crea una nuova tab */
        function newFile() {
            const defaultLanguage = 'html';
            const newFileName = `untitled-${untitledCounter}${getExtensionForLanguage(defaultLanguage)}`;
            untitledCounter++;
            const newContent = `\n`; 
            
            createTab(newFileName, defaultLanguage, newContent);
        }

        /** Apre un file in una nuova tab */
        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html,.css,.js,.txt,.md';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        const fileName = file.name;
                        const language = getLanguageFromFileName(fileName);
                        
                        const newTab = createTab(fileName, language, content);
                        newTab.isModified = false; 
                        
                        updateTabUI(newTab);
                        updateModifiedStatus();
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        /** Salva la tab attiva */
        async function saveFile() {
            const activeTab = getActiveTab();
            if (!activeTab) return; 

            try {
                if ('showSaveFilePicker' in window) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: activeTab.name,
                        types: [{
                            description: 'File di codice',
                            accept: {
                                'text/html': ['.html'],
                                'text/css': ['.css'],
                                'text/javascript': ['.js'],
                                'text/plain': ['.txt'],
                                'text/markdown': ['.md'] // Aggiunto supporto Markdown
                            }
                        }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(activeTab.model.getValue());
                    await writable.close();
                    
                    // Aggiorna lo stato della tab
                    activeTab.isModified = false;
                    const oldLang = activeTab.language;
                    activeTab.name = handle.name; // Aggiorna il nome
                    
                    // Aggiorna la lingua se l'utente ha cambiato l'estensione
                    const newLang = getLanguageFromFileName(activeTab.name);
                    if (newLang !== oldLang) {
                        activeTab.language = newLang;
                        monaco.editor.setModelLanguage(activeTab.model, newLang);
                    }
                    
                    // Aggiorna la UI
                    updateTabUI(activeTab);
                    updateUIForActiveTab(); 
                    
                    // Mostra modale invece di alert
                    showModal('Salvataggio', 'File salvato con successo!');
                } else {
                    downloadFile(); // Fallback
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Errore nel salvataggio:', err);
                    // Mostra modale errore invece di alert
                    showModal('Errore', 'Si è verificato un errore nel salvataggio del file.');
                }
            }
        }

        /** Scarica la tab attiva */
        function downloadFile() {
            const activeTab = getActiveTab();
            if (!activeTab) return;

            const content = activeTab.model.getValue();
            const fileName = activeTab.name;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            activeTab.isModified = false;
            updateTabUI(activeTab);
            updateModifiedStatus();
        }

        // Shortcut da tastiera
        window.addEventListener('keydown', (e) => {
            // Ctrl+S per salvare
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            // Ctrl+O per aprire
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                openFile();
            }
            // Ctrl+N per nuovo file
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                newFile();
            }
            // F11 per fullscreen
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            // Ctrl+B per toggle sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Avvisa prima di chiudere se ci sono modifiche non salvate
        window.addEventListener('beforeunload', (e) => {
            const hasModifications = tabs.some(tab => tab.isModified);
            if (hasModifications) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
